<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>node | realguess</title>
  <meta name="author" content="Chao Huang">
  
  <meta name="description" content="Just a blog about every detail encountered.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="realguess"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="realguess" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45698182-1', 'realguess.net');
  ga('send', 'pageview');
</script>


</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">realguess</a></h1>
  <h2><a href="/">Don't afraid to try!</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title tag">node</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-04-02T07:30:00.000Z"><a href="/2014/04/02/difference-between-require-and-fs-in-loading-files/">Apr 2, 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/04/02/difference-between-require-and-fs-in-loading-files/">Difference between require and fs in Loading Files</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Node has a simple module loading system by using <code>require</code>.</p>
<blockquote>
<p>A module prefixed with <code>&#39;/&#39;</code> is an absolute path to the file. For example, <code>require(&#39;/home/marco/foo.js&#39;)</code> will load the file at <code>/home/marco/foo.js</code>.</p>
<p>A module prefixed with <code>&#39;./&#39;</code> is relative to the file calling <code>require()</code>. That is, <code>circle.js</code> must be in the same directory as <code>foo.js</code> for <code>require(&#39;./circle&#39;)</code> to find it.</p>
<p>Without a leading <code>&#39;/&#39;</code> or <code>&#39;./&#39;</code> to indicate a file, the module is either a “core module” or is loaded from a <code>node_modules</code> folder.</p>
<p><a href="http://nodejs.org/api/modules.html#modules_file_modules">http://nodejs.org/api/modules.html#modules_file_modules</a></p>
</blockquote>
<p>We can also use it to load JSON files by simply specifying the file path. File path can be relative or absolute. Giving the following file structure:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>.
├── app<span class="variable">.js</span>
├── data
│   └── file<span class="variable">.json</span>
└── lib
    └── util<span class="variable">.js</span>
</pre></td></tr></table></figure>

<p>Let&#39;s say the root path of the application is <code>/home/marco</code>. Use relative path from the file <code>lib/util.js</code>:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">var</span> json = require(<span class="string">'../data/file.json'</span>);
</pre></td></tr></table></figure>

<p>This will load the JSON content from <code>data/file.json</code>, because the require system knows that the file is relative to the calling file <code>lib/util.js</code>. But when using <a href="http://nodejs.org/api/fs.html">file system</a> functions, relative path is not treat the same way:</p>
<blockquote>
<p>Relative path to filename can be used, remember however that this path will be relative to <code>process.cwd()</code>. - <a href="http://nodejs.org/api/fs.html">File System</a></p>
</blockquote>
<p><code>process.cwd()</code> returns the current working directory, not the root directory of the application nor the directory of the calling file. For example:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">var</span> data = fs.readFileSync(<span class="string">'../data/file.json'</span>);
</pre></td></tr></table></figure>

<p>If your current working directory is <code>/home/marco/myapp</code>, the application root directory, you will get the following error message:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="transposed_variable">fs.</span>js:<span class="number">410</span>
  <span class="keyword">return</span> <span class="transposed_variable">binding.</span>open(<span class="transposed_variable">pathModule.</span>_makeLong(path), stringToFlags(flags), mode);
                 ^
Error: ENOENT, no such file or directory <span class="string">'../data/file.json'</span>
    at <span class="transposed_variable">Object.</span><span class="transposed_variable">fs.</span>openSync (<span class="transposed_variable">fs.</span>js:<span class="number">410</span>:<span class="number">18</span>)
    at <span class="transposed_variable">Object.</span><span class="transposed_variable">fs.</span>readFileSync (<span class="transposed_variable">fs.</span>js:<span class="number">276</span>:<span class="number">15</span>)
</pre></td></tr></table></figure>

<p>Because <code>process.cwd()</code> is <code>/home/marco/myapp</code>, and reading file relative to this directory with <code>../data/file.json</code>, Node will expect file path to be <code>/home/marco/data/file.json</code>. Therefore, the error is thrown.</p>
<p>The difference between <code>require</code> and <code>fs</code> in loading files is that if the relative path is used in <code>require</code>, it is relative to the file calling the <code>require</code>. If the relative path is used in <code>fs</code>, it is relative to <code>process.cwd()</code>.</p>
<p>To fix the error in file system functions, we should always use absolute path. One thing we can do is:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">var</span> data = fs.readFileSync(__dirname + <span class="string">'/../data/file.json'</span>);
</pre></td></tr></table></figure>

<p><code>__dirname</code> is “the name of the directory that the currently executing script is resides in” [<a href="http://nodejs.org/api/globals.html#globals_dirname">dirname</a>], and it has no trailing slash. The the structure looks odd, even though it works, but it might not work in all systems.</p>
<p>The correct solution here is to use <code>path.join</code> from <a href="http://nodejs.org/api/path.html">Path</a>:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">var</span> data = fs.readFileSync(path.join(__dirname, <span class="string">'../data/file.json'</span>));
</pre></td></tr></table></figure>

<p>The <code>path</code> module “contains utilities for handling and transforming file paths”. The <code>path.join</code> function will call <code>path.normalize</code> to &quot;normalize a string path, taking care of <code>..</code> and <code>.</code> paths&quot; [<a href="http://nodejs.org/api/path.html#path_path_normalize_p">normalize</a>], also see function <code>normalizeArray</code> in <a href="https://github.com/joyent/node/blob/master/lib/path.js">https://github.com/joyent/node/blob/master/lib/path.js</a> on how the paths are normalized.</p>
<p>In conclusion:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="comment">// Use `require` to load JSON file.</span>
<span class="keyword">var</span> json = require(<span class="string">'../data/file.json'</span>);

<span class="comment">// Use `fs` to load JSON file.</span>
<span class="keyword">var</span> data = fs.readFileSync(path.join(__dirname, <span class="string">'../data/file.json'</span>));
<span class="keyword">var</span> json = JSON.parse(data.toString());
</pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-12T06:42:55.000Z"><a href="/2014/02/11/defining-correct-environment-for-coffeescript-in-cron/">Feb 11, 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/11/defining-correct-environment-for-coffeescript-in-cron/">Defining Correct Environment for CoffeeScript in Cron</a></h1>
  

    </header>
    <div class="entry">
      
        <p>I have written a bunch of CoffeeScript scripts that I would like to run them regularly. <a href="http://en.wikipedia.org/wiki/Cron">Cron</a> is certainly the right choice in many situation.</p>
<p>The default executable path recognized by cron is limited:</p>
<pre><code>* * * * * echo <span class="variable">$PATH</span> &gt; <span class="regexp">/tmp/log</span><span class="regexp">/cron.log</code></pre>
<p>This cron job will recognize the following path:</p>
<pre><code>/usr/bin:<span class="regexp">/bin</code></pre>
<p>However the default executable path for Node.js is usually at:</p>
<pre><code><span class="variable">$ </span>which node
/usr/local/bin/node</code></pre>
<p>Therefore, if you attempt to run a cron job:</p>
<pre><code>* * * * * node -v &gt; /tmp/<span class="built_in">log</span>/cron.<span class="built_in">log</span> <span class="number">2</span>&gt; /tmp/<span class="built_in">log</span>/cron.<span class="built_in">err</span>.<span class="built_in">log</span></code></pre>
<p>It will return an error, where the executable is not found:</p>
<pre><code><span class="attribute">bin/sh</span>: <span class="string">1: node: not found</span></code></pre>
<p>The easiest way to solve it is by specifying the fully qualified path:</p>
<pre><code>* * * * * <span class="regexp">/usr/local</span><span class="regexp">/bin/node</span> -v &gt; <span class="regexp">/tmp/log</span><span class="regexp">/cron.log</code></pre>
<p>To ensure the process is installed, we can check the file existence and permission before launching it:</p>
<pre><code><span class="bullet">* </span><span class="bullet">* *</span> <span class="bullet">* *</span> test -x /usr/local/bin/node &amp;&amp; /usr/local/bin/node -v</code></pre>
<p>But when working with CoffeeScript, the same method does not working:</p>
<pre><code>* * * * * <span class="regexp">/usr/local</span><span class="regexp">/bin/coffee</span> -v <span class="number">2</span>&gt; <span class="regexp">/tmp/log</span><span class="regexp">/cron.err.log</code></pre>
<p>Because CoffeeScript binary (<code>coffee</code>) use the following format:</p>
<pre><code><span class="shebang">#!/usr/bin/env node</span></code></pre>
<p>Which does not specify fully qualified path on the shebang line, and will result in:</p>
<pre><code>/usr/bin/<span class="method">env:</span> <span class="method">node:</span> <span class="class">No</span> such file or directory</code></pre>
<p>We can compile CoffeeScript into JavaScript and use fully qualified <code>node</code> executable. But this is not necessary. Since we are using Debian based system, which uses Vixie cron. It allows environment variables to be defined. We can make Cron aware of the custom path in environment variable:</p>
<pre><code>* * * * * <span class="constant">PATH</span>=<span class="variable">$PATH</span><span class="symbol">:/usr/local/bin</span> coffee -v &gt; <span class="regexp">/tmp/log</span><span class="regexp">/cron.log</code></pre>
<p>Now the executable path include the one where both <code>node</code> and <code>coffee</code> commands reside.</p>
<p>We can also move it to its own line. But Cron is not shell, it does not expand the variable, so you have to specify all paths:</p>
<pre><code><span class="comment"># Error: `PATH=$PATH:/usr/local/bin`</span>
<span class="constant">PATH</span>=<span class="regexp">/usr/bin</span><span class="symbol">:/bin</span><span class="symbol">:/usr/local/bin</span>
* * * * * coffee -v &gt; <span class="regexp">/tmp/log</span><span class="regexp">/cron.log</code></pre>
<p>The good practice is to set environment variables in a script:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="comment">#!/usr/bin/env bash</span>
<span class="comment">#</span>
<span class="comment"># This script is intended to be run as a cron job.</span>

<span class="constant">PATH</span>=<span class="variable">$PATH</span><span class="symbol">:/usr/local/bin</span>
coffee -v
</pre></td></tr></table></figure>

<p>and run the script as a cron job:</p>
<pre><code>* * * * * /path/<span class="keyword">to</span>/script &gt; /tmp/<span class="built_in">log</span>/cron.<span class="built_in">log</span> <span class="number">2</span>&gt;&gt; /tmp/<span class="built_in">log</span>/cron.<span class="built_in">err</span>.<span class="built_in">log</span></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-17T22:13:03.000Z"><a href="/2014/01/17/a-new-nodejs-web-framework-koa/">Jan 17, 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/17/a-new-nodejs-web-framework-koa/">A New NodeJS Web Framework - Koa</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Taking the first spin on <a href="http://koajs.com/">Koa</a>, a new web framework designed by the team behind <a href="http://expressjs.com/">Express</a>.</p>
<h2>Requirements</h2>
<ol>
<li>Node v0.11.9 or higher is required for generator support.</li>
<li><code>--harmony</code> flag must be used when running Node.</li>
</ol>
<p>Without the <code>--harmony</code> flag, genertor function cannot be defined:</p>
<pre><code><span class="function"><span class="keyword">function</span> *<span class="title">fn</span><span class="params">()</span> {</span>
           ^
SyntaxError: Unexpected token *
    at <span class="transposed_variable">exports.</span>runInThisContext (<span class="transposed_variable">vm.</span>js:<span class="number">69</span>:<span class="number">16</span>)
    at <span class="transposed_variable">Module.</span>_compile (<span class="transposed_variable">module.</span>js:<span class="number">432</span>:<span class="number">25</span>)
    at <span class="transposed_variable">Object.</span><span class="transposed_variable">Module.</span><span class="transposed_variable">_extensions..</span>js (<span class="transposed_variable">module.</span>js:<span class="number">467</span>:<span class="number">10</span>)
    at <span class="transposed_variable">Module.</span>load (<span class="transposed_variable">module.</span>js:<span class="number">349</span>:<span class="number">32</span>)
    at <span class="transposed_variable">Function.</span><span class="transposed_variable">Module.</span>_load (<span class="transposed_variable">module.</span>js:<span class="number">305</span>:<span class="number">12</span>)
    at <span class="transposed_variable">Function.</span><span class="transposed_variable">Module.</span>runMain (<span class="transposed_variable">module.</span>js:<span class="number">490</span>:<span class="number">10</span>)
    at startup (<span class="transposed_variable">node.</span>js:<span class="number">123</span>:<span class="number">16</span>)
    at <span class="transposed_variable">node.</span>js:<span class="number">1031</span>:<span class="number">3</span></code></pre>
<p>So, set the <code>--harmony</code> flag in shell alias:</p>
<pre><code>$ <span class="keyword">alias</span> node=<span class="attribute">'node</span> <span class="comment">--harmony'</span></code></pre>
<p>To know more:</p>
<pre><code>$ man node
--harmony (enable all harmony features (except <span class="keyword">typeof</span>))
      type: <span class="keyword">bool</span>  <span class="keyword">default</span>: <span class="keyword">false</span></code></pre>
<p><em>Harmony</em> is the codename of ECMAScript 6, the next version of the standard.</p>
<h2>Install</h2>
<pre><code><span class="variable">$ </span>npm install koa</code></pre>
<p>The footprint of the framework is small. Therefore, there is no executable binary like Express, and we do not need to install it globally.</p>
<h2>Dependencies</h2>
<p>Dependencies on version 0.2.1:</p>
<pre><code><span class="string">"dependencies"</span>: {
  <span class="string">"accepts"</span>: <span class="string">"~1.0.0"</span>,
  <span class="string">"type-is"</span>: <span class="string">"~1.0.0"</span>,
  <span class="string">"on-socket-error"</span>: <span class="string">"~1.0.1"</span>,
  <span class="string">"co"</span>: <span class="string">"~3.0.1"</span>,
  <span class="string">"debug"</span>: <span class="string">"<span class="variable">*"</span>,
  "</span>mime<span class="string">": "</span>~<span class="number">1.2</span>.<span class="number">11</span><span class="string">",
  "</span>fresh<span class="string">": "</span>~<span class="number">0</span>.<span class="number">2.0</span><span class="string">",
  "</span>koa-compose<span class="string">": "</span>~<span class="number">2.1</span>.<span class="number">0</span><span class="string">",
  "</span>cookies<span class="string">": "</span>~<span class="number">0</span>.<span class="number">3.7</span><span class="string">",
  "</span>keygrip<span class="string">": "</span>~<span class="number">1.0</span>.<span class="number">0</span><span class="string">"
}</code></pre>
<h2>Middleware</h2>
<p>Middleware system is the core of either Express or Koa based application. This needs a separate post. Here just describes the difference in design.</p>
<p>In a simple assembly design, each unit passes control to the next one until the last one terminates and responses to the request:</p>
<pre><code>    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
<span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">o</span>
    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></code></pre>
<p>Express middleware passes control to the next one like an assembly line, but each unit is capable of responding to the request:</p>
<pre><code>       <span class="comment">o</span>           <span class="comment">o</span>           <span class="comment">o</span>
       <span class="comment">|</span>           <span class="comment">|</span>           <span class="comment">|</span>
    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
<span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span>
    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></code></pre>
<p>Koa provides a traceback via generator, each unit is capable of working on the request twice instead of once as previous two designs. It is stack alike, where the first generator will also be the last one prior to responding to request:</p>
<pre><code>       <span class="comment">o</span>
       <span class="comment">|</span>
    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
<span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">|</span>     <span class="comment">|</span>
    <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
       <span class="comment">^</span>          <span class="comment">|</span> <span class="comment">^</span>         <span class="comment">|</span>
       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></code></pre>
<p>This is sort of an assembly loop, where the starting station is also be the ending station.</p>
<h2>Usage</h2>
<p>Here is one liner:</p>
<pre><code>require(<span class="string">'koa'</span>)().use(<span class="function"><span class="keyword">function</span> *<span class="params">()</span> { <span class="title">this</span>.<span class="title">body</span> = '<span class="title">OK</span>'; }).<span class="title">listen</span><span class="params">(3000)</span>;</span></code></pre>
<p><code>app.use</code> requires a generator function or <code>function *()</code>. Koa middleware uses <code>this</code> (context) instead of <code>req</code> and <code>res</code> in Express. It also encapsulates Node&#39;s <code>request</code> and <code>response</code> objects. For example, <code>this</code> or context has the following properties:</p>
<pre><code>[ &#39;request&#39;,     // Koa request
  &#39;response&#39;,    // Koa response
  &#39;app&#39;,
  &#39;req&#39;,         // Node request
  &#39;res&#39;,         // Node response
  &#39;onerror&#39;,
  &#39;originalUrl&#39;,
  &#39;cookies&#39;,
  &#39;accept&#39; ]</code></pre>
<h3>Status and Body</h3>
<p>Status can be used as a flag indicating whether a request has been processed or not:</p>
<pre><code>app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span> *<span class="params">()</span> {</span>
  console.log(<span class="keyword">this</span>.status); <span class="comment">// undefined</span>
  <span class="keyword">this</span>.body = <span class="string">'processed'</span>;
  console.log(<span class="keyword">this</span>.status); <span class="comment">// 200</span>
});</code></pre>
<p>When the <code>body</code> is populated, <code>status</code> is automatically updated, probably via the <code>nextTick</code> method. So, we can use it as the flag to design a response such as a custom not found response.</p>
<h3>Not Found</h3>
<p>Create a custom <code>Not Found</code> in JSON content type:</p>
<pre><code>app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span> *<span class="params">(next)</span> {</span>
  yield next; <span class="comment">// The operation is yet to start.</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.status) { <span class="keyword">return</span>; }

  <span class="keyword">this</span>.status = <span class="number">404</span>;
  <span class="keyword">this</span>.body = { message: <span class="string">'Cannot find what you are looking for :('</span> };
});
app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span> *<span class="params">()</span> {</span>}); <span class="comment">// Do nothing to simulate not found.</span></code></pre>
<h3>Error Handling</h3>
<p>Koa app is capable of catching the error event:</p>
<pre><code>app.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, ctx)</span> {</span>
  <span class="comment">// Log errors.</span>
});</code></pre>
<p>where <code>ctx</code> is a context instance. But you cannot modify the response body. This is more for server side logging and debugging purpose. The <code>500 Internal Server Error</code> will be returned to the client.</p>
<p>We can use <code>try..catch</code> to define a custom error handling middleware:</p>
<pre><code>app.use(<span class="function"><span class="keyword">function</span> *<span class="params">(next)</span> {</span>
  <span class="keyword">try</span> {
    <span class="keyword">yield</span> next;
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">this</span>.status = err.status || <span class="number">500</span>;
    <span class="keyword">this</span>.body   = { message: err.message || <span class="string">'Bad stuff happened!'</span> };
    <span class="keyword">this</span>.app.emit(<span class="string">'error'</span>, err, <span class="keyword">this</span>); <span class="comment">// Enable error event handling</span>
  }
});</code></pre>
<p>Make sure to emit the error event and let the server log the error.</p>
<p>All non-operational middleware (e.g., not found or error) should be defined first, so it can be traced back as the last guards before sending response back.</p>
<h3>Routing</h3>
<p>Out of the box, Koa does not support routing, but it can be achieved via routing middleware, see <a href="https://github.com/koajs/koa/wiki">examples</a>.</p>
<h2>Examples</h2>
<p>Define an app with only one middleware generator function:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="function"><span class="keyword">function</span> *<span class="title">foo</span><span class="params">(next)</span> {</span>
  console.log(<span class="string">'foo'</span>);
  <span class="keyword">this</span>.status = <span class="number">204</span>;
}
require(<span class="string">'koa'</span>)().use(foo).listen(<span class="number">3000</span>);
</pre></td></tr></table></figure>

<p>Instead of using status code <code>200</code>, we use <code>204</code> here, because the response contains no body. If using <code>200</code>, the server does not know the total content length, will result in <code>Transfer-Encoding: chunked</code> header instead of <code>Content-Length</code>. See <a href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">chunked transfer encoding</a>.</p>
<p>This app simply prints out <code>foo</code> on the server side, and respond to a client with status code <code>204</code> and an empty body. We can even omit the <code>next</code> parameter, since we are not using it.</p>
<p>Now let&#39;s use two middleware generator functions:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="comment">// Response: foo</span>
<span class="function"><span class="keyword">function</span> *<span class="title">foo</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'foo'</span>;
}
<span class="function"><span class="keyword">function</span> *<span class="title">bar</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'bar'</span>;
}
require(<span class="string">'koa'</span>)().use(foo).use(bar).listen(<span class="number">3000</span>);
</pre></td></tr></table></figure>

<p>Since generator <code>foo</code> sets the body, generator <code>bar</code> will never be reached. We can change that by adding the <code>yield</code>: </p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="comment">// Response: bar</span>
<span class="function"><span class="keyword">function</span> *<span class="title">foo</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'foo'</span>;
  <span class="keyword">yield</span> next;
}
<span class="function"><span class="keyword">function</span> *<span class="title">bar</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'bar'</span>;
  <span class="keyword">yield</span> next;
}
require(<span class="string">'koa'</span>)().use(foo).use(bar).listen(<span class="number">3000</span>);
</pre></td></tr></table></figure>

<p>This looks alot like Express, <code>yeild next</code> is similar to <code>next()</code>. Request travels through the middleware system first via <code>foo</code> then <code>bar</code>. But actually by using generator, it also returns back to <code>foo</code> as <code>foo-&gt;bar-&gt;foo</code>:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="comment">// Response: foo again</span>
<span class="function"><span class="keyword">function</span> *<span class="title">foo</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'foo'</span>;
  <span class="keyword">yield</span> next;
  <span class="keyword">this</span>.body = <span class="string">'foo again'</span>;
}
<span class="function"><span class="keyword">function</span> *<span class="title">bar</span><span class="params">(next)</span> {</span>
  <span class="keyword">this</span>.body = <span class="string">'bar'</span>;
  <span class="keyword">yield</span> next;
}
require(<span class="string">'koa'</span>)().use(foo).use(bar).listen(<span class="number">3000</span>);
</pre></td></tr></table></figure>

<p>This is similar to a stack alike request model, where the first middleware should also be the last middleware to touch the request. There is a no-op middleware in the end to catch the last <code>yield next</code> produced by <code>bar</code> middleware generator and traces back the stack.</p>
<h2>Debugging</h2>
<p>Set environment variable <code>DEBUG=koa*</code> to enable Koa specific debugging information in development environment:</p>
<pre><code><span class="variable">$ </span><span class="constant">DEBUG</span>=koa* node app.js</code></pre>
<p>You will see a list of middleware. If a middleware is an anonymous function, we can set <code>._name</code> to define a custom name:</p>
<pre><code><span class="function"><span class="keyword">function</span> *<span class="title">foo</span><span class="params">(next)</span> <span class="comment">{
  // Middleware definition starts here.
}</span>
<span class="title">foo</span>._<span class="title">name</span> = '<span class="title">bar</span>';</span>
app.use(foo);</code></pre>
<p>The middleware name will be <code>bar</code> instead of <code>foo</code>.</p>
<h2>Resources</h2>
<ol>
<li><a href="http://koajs.com/">Koa</a></li>
<li><a href="https://github.com/koajs/koa">Koa | GitHub</a></li>
<li><a href="https://github.com/koajs/koa/blob/master/docs/guide.md">Koa Quick Guide</a></li>
<li><a href="https://github.com/koajs/koa/wiki">Koa Middleware List</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-09T17:18:19.000Z"><a href="/2014/01/09/working-with-big-number-in-javascript/">Jan 9, 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/09/working-with-big-number-in-javascript/">Working with Big Number in JavaScript</a></h1>
  

    </header>
    <div class="entry">
      
        <p>JavaScript is only capable of handling 53-bit numbers, if you are working with a big number such as <a href="https://dev.twitter.com/docs/twitter-ids-json-and-snowflake">Twitter ID</a>, which is using 64-bit number, then you need to find an external library to do that, otherwise, there will be precision lost:</p>
<pre><code><span class="blockquote">&gt; num = 420938523475451904</span>
420938523475451900
<span class="blockquote">&gt; num = 420938523475451904 + 1</span>
420938523475451900
<span class="blockquote">&gt; num = 420938523475451904 - 1</span>
420938523475451900</code></pre>
<p>Here is one library to use in Node environment, install <a href="https://github.com/MikeMcl/big.js/">Big.js</a>:</p>
<pre><code><span class="variable">$ </span>npm install big.js</code></pre>
<p>Load the module:</p>
<pre><code>&gt; BigNum = require(<span class="comment">'big.js')</span>
{ [<span class="keyword">Function</span>: Big] DP: <span class="number">20</span>, RM: <span class="number">1</span> }</code></pre>
<p>Use string to create the big number:</p>
<pre><code>&gt; num = <span class="class">BigNum</span>(<span class="string">'420938523475451904'</span>)
{ <span class="method">s:</span> <span class="number">1</span>,
  <span class="method">e:</span> <span class="number">17</span>,
  <span class="method">c:</span> [ <span class="number">4</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">4</span> ] }
&gt; num.toString()
<span class="string">'420938523475451904'</span></code></pre>
<p>Perform addition:</p>
<pre><code><span class="blockquote">&gt; num.plus(1).toString()</span>
'420938523475451905'</code></pre>
<p>Perform substraction:</p>
<pre><code><span class="blockquote">&gt; num.minus(1).toString()</span>
'420938523475451903'</code></pre>
<p>There are other packages that yet to be tested:</p>
<ul>
<li><a href="https://github.com/MikeMcl/bignumber.js/">bignumber.js</a></li>
<li><a href="https://github.com/rauschma/strint">strint.js</a></li>
<li><a href="http://jsfromhell.com/classes/bignumber">bignumber</a></li>
<li><a href="https://github.com/jtobey/javascript-bignum">JavaScript bignumber</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-12-18T23:12:43.000Z"><a href="/2013/12/18/set-filename-path-with-processcwd()/">Dec 18, 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/12/18/set-filename-path-with-processcwd()/">Set Filename Path with process.cwd()</a></h1>
  

    </header>
    <div class="entry">
      
        <p>When working with <a href="http://nodejs.org/api/fs.html">file system</a> in Node, you will need a fully qualified filename to do things like reading the content of a file:</p>
<pre><code><span class="function"><span class="title">require</span><span class="params">('fs')</span>.<span class="title">readFile</span><span class="params">(filename, function (err, data) <span class="tuple">{}</span>);</code></pre>
<p>If you have the following directory structure:</p>
<pre><code>.
├── app<span class="variable">.js</span>
├── data
│   └── file<span class="variable">.txt</span>
└── lib
    └── reader<span class="variable">.js</span></code></pre>
<p>There are two ways to read the content of <code>data/file.txt</code> from <code>lib/reader.js</code>:</p>
<p>Use the current directory of the script <code>__dirname</code>:</p>
<pre><code><span class="comment">filename</span> <span class="comment">=</span> <span class="comment">__dirname</span> <span class="literal">+</span> <span class="comment">'/</span>.<span class="string">.</span><span class="comment">/data/file</span>.<span class="comment">txt';</code></pre>
<p>or with <code>path.join</code> to normalize the resulting path:</p>
<pre><code><span class="setting">filename = <span class="value">path.join(__dirname, '../data/file.txt');</span></span></code></pre>
<p>The second method is to use the current working directory of the process <code>process.cwd()</code>:</p>
<pre><code><span class="setting">filename = <span class="value">process.cwd() + '/data/file.txt';</span></span></code></pre>
<p>The second approach is more portable. If you move <code>lib/reader.js</code> to <code>lib/utils/reader.js</code>, no code change will be needed. But make sure the directory of the Node process is the application root directory where <code>node app.js</code> is being issued.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-17T20:30:17.000Z"><a href="/2013/11/17/why-shebang/">Nov 17, 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/17/why-shebang/">Why Shebang?</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Frequently the initial two characters on the initial line of a script are: <code>#!</code>.</p>
<p><em>Why <a href="http://en.wikipedia.org/wiki/Shebang_(Unix)">Shebang</a>?</em> Well, simple reason, because shell needs to know which interpreter to use when executing the script.</p>
<blockquote>
<p>The sha-bang (<code>#!</code>) at the head of a script tells your system that this file is a set of commands to be fed to the command interpreter indicated. The <code>#!</code> is actually a two-byte magic number, a special marker that designates a file type, or in this case an executable shell script (type man magic for more details on this fascinating topic). Immediately following the sha-bang is a path name. This is the path to the program that interprets the commands in the script, whether it be a shell, a programming language, or a utility. This command interpreter then executes the commands in the script, starting at the top (the line following the sha-bang line), and ignoring comments. - <a href="http://tldp.org/LDP/abs/html/sha-bang.html">Starting Off With a Sha-Bang</a></p>
</blockquote>
<p>The shebang line is usually ignored by the interpreter because the <code>#</code> character is a comment marker in many scripting languages. Even the actual script is written with a different commenting character, such as in JavaScript:</p>
<figure class="highlight lang-shell"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="shebang">#!/usr/bin/env node</span>
<span class="comment">// JavaScript stuff starts here.</span>
</pre></td></tr></table></figure>

<p>Because the first line is interpreted by the shell, and the rest is passed into JavaScript interpreter, in this case, Node.</p>
<p>The syntax of shebang:</p>
<pre><code><span class="shebang">#! interpreter [optional-arg]</span></code></pre>
<p>Whether there is a space between shebang character and the interpreter or not, it does not matter.</p>
<p>The interpreter must usually be an absolute path to a program that is not itself a script. The following are example interpreters:</p>
<figure class="highlight lang-shell"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="shebang">#! /bin/sh</span>
<span class="shebang">#! /bin/bash</span>
</pre></td></tr></table></figure>

<p>More examples are via <code>head -n 1 /etc/init.d/*</code>.</p>
<blockquote>
<p>The optional‑arg should either not be included or it should be a string that is meant to be a single argument (for reasons of portability, it should not contain any whitespace). - <a href="http://en.wikipedia.org/wiki/Shebang_(Unix)">Shebang_(Unix)</a></p>
</blockquote>
<p>We also frequently see the following shebang:</p>
<figure class="highlight lang-shell"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="shebang">#!/usr/bin/env bash</span>
</pre></td></tr></table></figure>

<p>That has to do with portability. Not every system install <code>node</code> or <code>bash</code> command in the same path. <code>/usr/bin/env</code> will search through user&#39;s <code>$PATH</code>, and correctly locate the executable.</p>
<p>To conclude for Node, here is the format I am using:</p>
<figure class="highlight lang-shell"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="preprocessor">#! /usr/bin/env node</span>

<span class="comment">// Title</span>
<span class="comment">// =====</span>
<span class="comment">//</span>
<span class="comment">// Markdown style description starts here.</span>

<span class="string">'use strict'</span>;
</pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-08T23:59:36.000Z"><a href="/2013/11/08/preserve-command-history-in-node-repl/">Nov 8, 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/08/preserve-command-history-in-node-repl/">Preserve command history in Node REPL</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Node <a href="http://nodejs.org/api/repl.html">REPL</a> (Read-Eval-Print-Loop) is a standalone JavaScript interpreter for Node. To invoke it, simply type:</p>
<pre><code><span class="variable">$ </span>node</code></pre>
<p>However, after exit and re-enter the REPL, all the previous commands are lost. This behaves very much different from what we expect from shell.</p>
<p>To maintain a persistent history, we can use <a href="http://utopia.knoware.nl/~hlub/uck/rlwrap/rlwrap.html">rlwrap</a> as suggested in this <a href="http://stackoverflow.com/a/18513951">answer</a>.</p>
<p>Install <a href="http://utopia.knoware.nl/~hlub/uck/rlwrap/rlwrap.html">rlwrap</a>:</p>
<pre><code>$ su<span class="operator"><span class="keyword">do</span> apt-<span class="keyword">get</span> install rlwrap</code></pre>
<p>Create an alias:</p>
<pre><code><span class="comment">alias</span> <span class="comment">node='env</span> <span class="comment">NODE_NO_READLINE=1</span> <span class="comment">rlwrap</span> <span class="literal">-</span><span class="comment">s</span> <span class="comment">1000</span> <span class="literal">-</span><span class="comment">S</span> <span class="comment">"node</span>&gt; <span class="comment">"</span> <span class="comment">node'</code></pre>
<p>Persistent history file is saved in:</p>
<pre><code>~<span class="regexp">/.node_history</code></pre>
<p>However, if by perserving the command history, Node REPL loses familiarity of color output and tab completion. This is a <a href="http://stackoverflow.com/a/9219349">trade-off</a>. To get around this problem, we can roll our own REPL or use an alternative. The best alternative I have found so far is also the one I am already using: <a href="http://coffeescript.org/#changelog">CoffeeScript</a> (see 1.6.3 change log). There is a history command built-in:</p>
<pre><code>$ coffee
coffee&gt; .help
.break  Sometimes you <span class="keyword">get</span> stuck, this gets you out
.clear  Break, <span class="keyword">and</span> also clear <span class="keyword">the</span> <span class="keyword">local</span> context
.<span class="keyword">exit</span>   Exit <span class="keyword">the</span> repl
.help   Show repl options
.history        Show command history
.load   Load JS <span class="keyword">from</span> a <span class="type">file</span> <span class="keyword">into</span> <span class="keyword">the</span> REPL session
.save   Save all evaluated commands <span class="keyword">in</span> this REPL session <span class="keyword">to</span> a <span class="type">file</span></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-06-29T16:11:46.000Z"><a href="/2013/06/29/share-javascript-code-between-browser-(front-end)-and-node-(back-end)/">Jun 29, 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/06/29/share-javascript-code-between-browser-(front-end)-and-node-(back-end)/">Share JavaScript Code between Browser (front-end) and Node (back-end)</a></h1>
  

    </header>
    <div class="entry">
      
        <p>One of the benefits coding in JavaScript is the ability to share code between<br>browser (front-end) and <a href="http://nodejs.org/">Node</a> (back-end) environments.</p>
<p>To share code between two different environment, first need to understand what<br>are specific to browser and what are specific to Node. Shared code should be<br>agnostic to both environments.</p>
<p>In browser environment, there is an obvious one: <code>window</code> object. In Node<br>environment, there are a few objects that are not globally defined in browser:<br><code>global</code>, <code>process</code>, <code>module</code>, <code>exports</code> and more, see <a href="http://nodejs.org/api/globals.html">global objects</a>. All<br>these variables work, but <code>exports</code> is preferred.</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>console.log(<span class="string">'Hi '</span> + (<span class="keyword">typeof</span> window !== <span class="string">'undefined'</span> ? <span class="string">'browser!'</span> : <span class="string">'Node!'</span>));
</pre></td></tr></table></figure>

<p>Once environment is identified, then it is just the matter of writing style,<br>either browser style or Node style.</p>
<p>For example, writing in Node style by passing the <code>exports</code> as the parameter:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>(<span class="function"><span class="keyword">function</span> <span class="params">(exports)</span> {</span>
  <span class="keyword">var</span> foo = exports.foo = {};

  <span class="comment">// Node style code goes here.</span>
}(<span class="keyword">typeof</span> exports === <span class="string">'undefined'</span> ? <span class="keyword">this</span> : exports));
</pre></td></tr></table></figure>

<p>By using browser style, here is an example from the <a href="http://underscorejs.org/docs/underscore.html">annotated source code</a> of<br><a href="http://underscorejs.org/">Underscore</a>:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="comment">// Export the Underscore object for Node.js, with backwards-compatibility</span>
<span class="comment">// for the old require() API. If we're in the browser, add _ as a global</span>
<span class="comment">// object via a string identifier, for Closure Compiler "advanced" mode.</span>
<span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">'undefined'</span> && module.exports) {
    exports = module.exports = _;
  }
  exports._ = _;
} <span class="keyword">else</span> {
  root._ = _;
}
</pre></td></tr></table></figure>

<p>To make it easier without concerning the backward compatibility:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> foo = {};

  <span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) {
    exports.foo = foo;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.foo = foo;
  }

  <span class="comment">// Browser style code goes here.</span>
}).call(<span class="keyword">this</span>);
</pre></td></tr></table></figure>

<p><code>this</code> is the same as <code>window</code> object in the browser environment.</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>(<span class="function"><span class="keyword">function</span> <span class="params">(window)</span> {</span>
  <span class="comment">// Browser style code goes here.</span>
}(<span class="keyword">this</span>));
</pre></td></tr></table></figure>

<p>One more thing, writing in <a href="coffeescript.org">CoffeeScript</a> is even better, because the compiled<br>code is already wrapped in closure, fewer indentation is needed.</p>
<figure class="highlight lang-coffeescript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>foo = {}
<span class="keyword">if</span> exports <span class="keyword">isnt</span> <span class="string">'undefined'</span>
  exports.foo = foo
<span class="keyword">else</span>
  <span class="keyword">this</span>.foo = foo

<span class="comment"># Browser style code goes here.</span>
</pre></td></tr></table></figure>

<p>Compile to JavaScript by <a href="coffeescript.org">CoffeeScript</a> 1.6.3:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>(<span class="keyword">function</span>() {
  <span class="keyword">var</span> foo;

  foo = {};

  <span class="keyword">if</span> (exports !== <span class="string">'undefined'</span>) {
    exports.foo = foo;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.foo = foo;
  }

}).call(<span class="keyword">this</span>);
</pre></td></tr></table></figure>

<p>Everything will be encapsulated inside the <code>foo</code> object.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:realguess.net">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/2013/">2013</a><small>1</small></li>
  
    <li><a href="/tags/absolute-path/">absolute-path</a><small>1</small></li>
  
    <li><a href="/tags/amazon/">amazon</a><small>1</small></li>
  
    <li><a href="/tags/amtrak/">amtrak</a><small>1</small></li>
  
    <li><a href="/tags/android/">android</a><small>1</small></li>
  
    <li><a href="/tags/android-4.3/">android-4.3</a><small>1</small></li>
  
    <li><a href="/tags/anonymous-function/">anonymous-function</a><small>1</small></li>
  
    <li><a href="/tags/array/">array</a><small>2</small></li>
  
    <li><a href="/tags/automatic-link/">automatic-link</a><small>1</small></li>
  
    <li><a href="/tags/awk/">awk</a><small>1</small></li>
  
    <li><a href="/tags/aws/">aws</a><small>2</small></li>
  
    <li><a href="/tags/aws-cli/">aws-cli</a><small>1</small></li>
  
    <li><a href="/tags/best-practice/">best-practice</a><small>1</small></li>
  
    <li><a href="/tags/big-apple/">big-apple</a><small>1</small></li>
  
    <li><a href="/tags/big-easy/">big-easy</a><small>1</small></li>
  
    <li><a href="/tags/big-number/">big-number</a><small>1</small></li>
  
    <li><a href="/tags/browser/">browser</a><small>1</small></li>
  
    <li><a href="/tags/cat/">cat</a><small>1</small></li>
  
    <li><a href="/tags/chat/">chat</a><small>1</small></li>
  
    <li><a href="/tags/chrome/">chrome</a><small>1</small></li>
  
    <li><a href="/tags/cli/">cli</a><small>1</small></li>
  
    <li><a href="/tags/cloud-storage/">cloud-storage</a><small>1</small></li>
  
    <li><a href="/tags/cocoon/">cocoon</a><small>1</small></li>
  
    <li><a href="/tags/coding-style/">coding-style</a><small>1</small></li>
  
    <li><a href="/tags/coffeelint/">coffeelint</a><small>1</small></li>
  
    <li><a href="/tags/coffeescript/">coffeescript</a><small>7</small></li>
  
    <li><a href="/tags/command-history/">command-history</a><small>1</small></li>
  
    <li><a href="/tags/command-line/">command-line</a><small>1</small></li>
  
    <li><a href="/tags/command-line-interface/">command-line-interface</a><small>1</small></li>
  
    <li><a href="/tags/configuration/">configuration</a><small>1</small></li>
  
    <li><a href="/tags/crescent/">crescent</a><small>1</small></li>
  
    <li><a href="/tags/cron/">cron</a><small>2</small></li>
  
    <li><a href="/tags/crontab/">crontab</a><small>1</small></li>
  
    <li><a href="/tags/cryptography/">cryptography</a><small>1</small></li>
  
    <li><a href="/tags/custom-domain/">custom-domain</a><small>1</small></li>
  
    <li><a href="/tags/custom-generator/">custom-generator</a><small>1</small></li>
  
    <li><a href="/tags/cwd/">cwd</a><small>1</small></li>
  
    <li><a href="/tags/datagram/">datagram</a><small>1</small></li>
  
    <li><a href="/tags/date/">date</a><small>1</small></li>
  
    <li><a href="/tags/diff/">diff</a><small>1</small></li>
  
    <li><a href="/tags/distributed-team/">distributed-team</a><small>1</small></li>
  
    <li><a href="/tags/docco/">docco</a><small>1</small></li>
  
    <li><a href="/tags/echo/">echo</a><small>1</small></li>
  
    <li><a href="/tags/ecmascript-harmony/">ecmascript-harmony</a><small>1</small></li>
  
    <li><a href="/tags/encryption/">encryption</a><small>1</small></li>
  
    <li><a href="/tags/environment/">environment</a><small>2</small></li>
  
    <li><a href="/tags/environment-variable/">environment-variable</a><small>1</small></li>
  
    <li><a href="/tags/express/">express</a><small>1</small></li>
  
    <li><a href="/tags/file-system/">file-system</a><small>1</small></li>
  
    <li><a href="/tags/filename/">filename</a><small>1</small></li>
  
    <li><a href="/tags/fs/">fs</a><small>1</small></li>
  
    <li><a href="/tags/function/">function</a><small>3</small></li>
  
    <li><a href="/tags/function-declaration/">function-declaration</a><small>2</small></li>
  
    <li><a href="/tags/function-expression/">function-expression</a><small>3</small></li>
  
    <li><a href="/tags/function-innovation/">function-innovation</a><small>1</small></li>
  
    <li><a href="/tags/generator/">generator</a><small>1</small></li>
  
    <li><a href="/tags/get/">get</a><small>1</small></li>
  
    <li><a href="/tags/ghost/">ghost</a><small>1</small></li>
  
    <li><a href="/tags/github/">github</a><small>1</small></li>
  
    <li><a href="/tags/goal/">goal</a><small>1</small></li>
  
    <li><a href="/tags/google-keep/">google-keep</a><small>1</small></li>
  
    <li><a href="/tags/grunt/">grunt</a><small>1</small></li>
  
    <li><a href="/tags/grunt-contrib-jshint/">grunt-contrib-jshint</a><small>1</small></li>
  
    <li><a href="/tags/grunt-contrib-watch/">grunt-contrib-watch</a><small>1</small></li>
  
    <li><a href="/tags/guard/">guard</a><small>1</small></li>
  
    <li><a href="/tags/head/">head</a><small>2</small></li>
  
    <li><a href="/tags/hipchat/">hipchat</a><small>1</small></li>
  
    <li><a href="/tags/hong-kong/">hong-kong</a><small>1</small></li>
  
    <li><a href="/tags/hosted-zone/">hosted-zone</a><small>1</small></li>
  
    <li><a href="/tags/http/">http</a><small>1</small></li>
  
    <li><a href="/tags/id/">id</a><small>1</small></li>
  
    <li><a href="/tags/iife/">iife</a><small>2</small></li>
  
    <li><a href="/tags/immediately-invoked-function-expression/">immediately-invoked-function-expression</a><small>2</small></li>
  
    <li><a href="/tags/interpreter/">interpreter</a><small>1</small></li>
  
    <li><a href="/tags/javascript/">javascript</a><small>8</small></li>
  
    <li><a href="/tags/jelly-bean/">jelly-bean</a><small>1</small></li>
  
    <li><a href="/tags/join/">join</a><small>1</small></li>
  
    <li><a href="/tags/jshint/">jshint</a><small>1</small></li>
  
    <li><a href="/tags/json/">json</a><small>1</small></li>
  
    <li><a href="/tags/koa/">koa</a><small>1</small></li>
  
    <li><a href="/tags/line-divider/">line-divider</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>3</small></li>
  
    <li><a href="/tags/livereload/">livereload</a><small>1</small></li>
  
    <li><a href="/tags/markdown/">markdown</a><small>2</small></li>
  
    <li><a href="/tags/mi3/">mi3</a><small>1</small></li>
  
    <li><a href="/tags/mongodb/">mongodb</a><small>1</small></li>
  
    <li><a href="/tags/mongoexport/">mongoexport</a><small>1</small></li>
  
    <li><a href="/tags/multi-parts/">multi-parts</a><small>1</small></li>
  
    <li><a href="/tags/named-function/">named-function</a><small>1</small></li>
  
    <li><a href="/tags/nb/">nb</a><small>1</small></li>
  
    <li><a href="/tags/network/">network</a><small>1</small></li>
  
    <li><a href="/tags/new-orleans/">new-orleans</a><small>1</small></li>
  
    <li><a href="/tags/new-york/">new-york</a><small>1</small></li>
  
    <li><a href="/tags/node/">node</a><small>8</small></li>
  
    <li><a href="/tags/nodemon/">nodemon</a><small>1</small></li>
  
    <li><a href="/tags/normalization/">normalization</a><small>1</small></li>
  
    <li><a href="/tags/nota-bene/">nota-bene</a><small>1</small></li>
  
    <li><a href="/tags/note-well/">note-well</a><small>1</small></li>
  
    <li><a href="/tags/npm/">npm</a><small>1</small></li>
  
    <li><a href="/tags/npm-module/">npm-module</a><small>1</small></li>
  
    <li><a href="/tags/null/">null</a><small>1</small></li>
  
    <li><a href="/tags/object/">object</a><small>1</small></li>
  
    <li><a href="/tags/parseint/">parseint</a><small>1</small></li>
  
    <li><a href="/tags/path/">path</a><small>3</small></li>
  
    <li><a href="/tags/ping/">ping</a><small>1</small></li>
  
    <li><a href="/tags/preinstall/">preinstall</a><small>1</small></li>
  
    <li><a href="/tags/process/">process</a><small>1</small></li>
  
    <li><a href="/tags/proxy/">proxy</a><small>1</small></li>
  
    <li><a href="/tags/query-parameter/">query-parameter</a><small>1</small></li>
  
    <li><a href="/tags/record-set/">record-set</a><small>1</small></li>
  
    <li><a href="/tags/relative-path/">relative-path</a><small>1</small></li>
  
    <li><a href="/tags/remote-working/">remote-working</a><small>1</small></li>
  
    <li><a href="/tags/repl/">repl</a><small>1</small></li>
  
    <li><a href="/tags/require/">require</a><small>1</small></li>
  
    <li><a href="/tags/rlwrap/">rlwrap</a><small>1</small></li>
  
    <li><a href="/tags/route-53/">route-53</a><small>1</small></li>
  
    <li><a href="/tags/scaffolding/">scaffolding</a><small>1</small></li>
  
    <li><a href="/tags/script/">script</a><small>1</small></li>
  
    <li><a href="/tags/settings/">settings</a><small>1</small></li>
  
    <li><a href="/tags/shabang/">shabang</a><small>1</small></li>
  
    <li><a href="/tags/sharing/">sharing</a><small>1</small></li>
  
    <li><a href="/tags/shebang/">shebang</a><small>1</small></li>
  
    <li><a href="/tags/shell/">shell</a><small>1</small></li>
  
    <li><a href="/tags/shell-script/">shell-script</a><small>1</small></li>
  
    <li><a href="/tags/source-maps/">source-maps</a><small>1</small></li>
  
    <li><a href="/tags/split/">split</a><small>1</small></li>
  
    <li><a href="/tags/sshuttle/">sshuttle</a><small>1</small></li>
  
    <li><a href="/tags/startup/">startup</a><small>1</small></li>
  
    <li><a href="/tags/stats/">stats</a><small>1</small></li>
  
    <li><a href="/tags/success/">success</a><small>1</small></li>
  
    <li><a href="/tags/sync/">sync</a><small>1</small></li>
  
    <li><a href="/tags/time-zone/">time-zone</a><small>1</small></li>
  
    <li><a href="/tags/todo/">todo</a><small>1</small></li>
  
    <li><a href="/tags/train/">train</a><small>1</small></li>
  
    <li><a href="/tags/travel/">travel</a><small>1</small></li>
  
    <li><a href="/tags/tumblr/">tumblr</a><small>1</small></li>
  
    <li><a href="/tags/twitter/">twitter</a><small>1</small></li>
  
    <li><a href="/tags/ubuntu/">ubuntu</a><small>1</small></li>
  
    <li><a href="/tags/uglifyjs/">uglifyjs</a><small>1</small></li>
  
    <li><a href="/tags/underscore/">underscore</a><small>1</small></li>
  
    <li><a href="/tags/unix/">unix</a><small>1</small></li>
  
    <li><a href="/tags/username/">username</a><small>1</small></li>
  
    <li><a href="/tags/vim/">vim</a><small>2</small></li>
  
    <li><a href="/tags/vimdiff/">vimdiff</a><small>1</small></li>
  
    <li><a href="/tags/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/tags/web-framework/">web-framework</a><small>1</small></li>
  
    <li><a href="/tags/xiaomi/">xiaomi</a><small>1</small></li>
  
    <li><a href="/tags/yeoman/">yeoman</a><small>1</small></li>
  
    <li><a href="/tags/yield/">yield</a><small>1</small></li>
  
    <li><a href="/tags/小米/">小米</a><small>1</small></li>
  
    <li><a href="/tags/小米手机/">小米手机</a><small>1</small></li>
  
  </ul>
</div>


  

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Chao Huang
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>